# Table of Contents
1. [Description](#desc)
2. [CMake on SIMLAB](#1)
3. [Example of cmake usage](#2)
4. [Additional information](#3)
    1. [Configuration options](#4)
    2. [The cache system](#5)
    3. [Compilation in a new directory](#6)
    4. [Choice of installation directory](#7)
    5. [Compiler options](#8)
    6. [Display the commands executed by make (built by CMake)](#9)
    7. [Save the configuration](#10)

## Description <a name="desc"></a>
CMake is a tool which allows automating the software compilation process. As with Autotools, it consists of build automation aiming to simplify the multi-platform compilation of a source code.

## CMake on SIMLAB <a name="1"></a>
- List available versions:

```sh
$ module avail CMake
----------------- /cm/shared/modulefiles ------------------
CMake/3.15.3-GCCcore-8.3.0  CMake/3.18.4-GCCcore-10.2.0  
CMake/3.16.4-GCCcore-9.3.0  
```
- Load CMake (version 3.16.4 compiled with GCC 9.3.0):
```sh
$ module load CMake/3.16.4-GCCcore-9.3.0
```
<details><summary>List modules</summary>
<p>

```sh 
$ module list
Currently Loaded Modulefiles:
1) GCCcore/9.3.0                    5) ncurses/6.2-GCCcore-9.3.0   
2) zlib/1.2.11-GCCcore-9.3.0        6) bzip2/1.0.8-GCCcore-9.3.0   
3) cURL/7.69.1-GCCcore-9.3.0        7) CMake/3.16.4-GCCcore-9.3.0  
4) Xerces-C++/3.2.3-GCCcore-9.3.0      
```

</p>
</details>

## Example of cmake usage <a name="2"></a>

Starting from a `CMakeLists.txt` configuration file, CMake generates Makefile files adapted to the target machine. Basically, in order to compile a software using CMake, you simply need to follow these steps:  
```sh
$ mkdir build; cd build/ # creation of a temporary directory for the compilation
$ cmake ../src/          # equivalent of the script ./configure the autotools
$ make                   # compilation
$ make install           # installation
```
Note that CMake also allows generating the configuration of other projects (Eclipse, Visual Studio, â€¦)

## Additional information <a name="3"></a>
### Configuration options <a name="4"></a>

The compilation options are stored in the CMake variables. These can be set on the command line by using option `-D` or by using the GUI.

Example :
```sh
$ cmake -DCMAKE_C_FLAGS="-O3 -xAVX" ../src/
```

The list of CMake variables is available here but each library adds its own options. You must consult the cache file, the `CMakeLists.txt` files or use the GUI to manage the variables.

### The cache system <a name="5"></a>

After having launched `cmake` the first time, the compilation parameters are saved in the cache file, `CMakeCache.txt`. Following this, it is possible to modify the configuration by re-launching `cmake`. During the first launching, the source directory must be used as an argument of `cmake`. Subsequently, you must indicate the temporary compilation directory:

```sh
$ cd build/
$ cmake -DCMAKE_CXX_FLAGS="-O3 -xAVX" .
```
After each modification, the configuration phase is repeated by using the cache inputs as initialisation values of the CMake variables.

As a complicated logic can exist between the compilation variables, it is sometimes less difficult to restart at zero when the first configuration phase does not take place correctly. In this case, it is necessary to delete the directory and set the CMake variables directly on the command line.
The graphical user interface (GUI)

The `ccmake` command allows accessing the CMake curses interface curses. Like the cmake command, `ccmake` takes a directory as argument.

```sh
$ cd build/
$ ccmake .
```
The `ccmake` interface displays all of the CMake variables which have an influence on the compilation. The variables can be modified and the Makefile files will consequently be regenerated.

The menu of available commands is found in the bottom section of the interface. To modify a variable, you must go on a line and press `[Enter]`.

After modifying a variable, the configuration phase can be relaunched by using `[c]`. The interface displays the result and you must type `[e]` to return to the menu of commands. By typing `[g]`, you may validate the modifications and leave the interface. The hidden variables are displayed by `[t]`.

### Compilation in a new directory <a name="6"></a>

CMake allows carrying out the compilation in a new directory which contains a copy of the source file. In this way, you can avoid polluting the source directory, easily delete the files generated by the compilation or install several versions of a library from the orginal source files.

To use this functionality, you simply need to call the cmake command from a directory dedicated to the compilation (e.g. the build directory). The cmake command takes the path to the source directory as argument.

The following example shows the usual organisation:
```sh
$ ls
src/  build-optim/  install-optim/
      build-debug/  install-debug/
      build-seq/    install-seq/
$ cd build-seq; cmake ../src/
```

### Choice of installation directory <a name="7"></a>

The CMake variable `CMAKE_INSTALL_PREFIX` allows choosing the directory to use for the library installation. This is the equivalent of the `--prefix` option of the ./configure script of Autotools.
```sh
$ cmake -DCMAKE_INSTALL_PREFIX=../install/ ../src/
```

### Compiler options <a name="8"></a>

As do most of the integrated development environments (IDE), CMake allows managing a project with a compilation configuration which is adapted to the developments (Debug mode) or to the production phase (Release mode).

The CMake variable `CMAKE_BUILD_TYPE` allows switching from one mode to the other. It is also possible to change each of the compiler options associated to the compilation modes individually.

```sh
$ cmake -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_FLAGS_RELEASE="-O3 -xAVX" \
        -DCMAKE_CXX_FLAGS_RELEASE="-O3 -xAVX" \
        -DCMAKE_C_FLAGS_DEBUG="-g" \
        -DCMAKE_CXX_FLAGS_DEBUG="-g"
```

### Display the commands executed by make (built by CMake) <a name="9"></a>

Use the environment variable `VERBOSE`. Example:
```sh
$ VERBOSE=1 make
```
### Save the configuration <a name="10"></a>

To facilitate the reinstallation of a library on a target machine, the best way is to save a small script in order to replicate the configuration phase.

```sh
CC=icc CXX=icpc cmake -DCMAKE_BUILD_TYPE:STRING=Release  \
                      -DCMAKE_INSTALL_PREFIX:PATH="$WORKDIR/opt/" \
                      -DCMAKE_CXX_FLAGS_RELEASE:STRING="-O3 -xAVX" \
                      -DCMAKE_C_FLAGS_RELEASE:STRING="-O3 -xAVX" \
                      ../src/
```
